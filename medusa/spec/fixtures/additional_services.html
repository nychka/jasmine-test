<!-- ADDITIONAL SERVICE -->
<section class="sms-services additional_services hidden" id="additional_services" data-service="additional_services">
    <div class="extras">


        <div class="extra-item additional_services_ins sms_block">
            <img class="extra-img" src="./payment_page_2_files/extra-2.gif">
            <h3>SMS-уведомление об отмене или задержке рейса</h3>
            <p>
                Обратите внимание, что иногда авиакомпании до вылета могут отменять, задерживать или переносить рейсы. Будьте в курсе всех изменений благодаря услуге SMS-уведомления!&nbsp;        </p>


            <ul class="additional_services_list">
                <li>
                    <input type="checkbox" data-action="avia-additional_services_sms" data-service-label="SMS-уведомление в случае отмены рейса" data-cost="149" name="sms-flight-cancel" value="sms-flight-cancel" id="id_sms-flight-cancel" class="ui-helper-hidden-accessible">
                    <label for="id_sms-flight-cancel" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false"><span class="ui-button-text">
                <svg width="16" height="16">
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox" class="icon-checkbox"></use>
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox1" class="icon-checkbox1"></use>
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox2" class="icon-checkbox2"></use>
                </svg>
                <span>SMS-уведомление в случае отмены рейса</span>

                                                                          <span data-currency="UAH" data-original-cost="68.77" data-cost="68.77" class="price_item hidden">
                      <strong>69 UAH</strong>
                    </span>
                                                          <span data-currency="USD" data-original-cost="2.54" data-cost="2.54" class="price_item hidden">
                      <strong>2.54 USD</strong>
                    </span>
                                                          <span data-currency="EUR" data-original-cost="2.18" data-cost="2.18" class="price_item hidden">
                      <strong>2.18 EUR</strong>
                    </span>
                                                          <span data-currency="RUR" data-original-cost="149.00" data-cost="149.00" class="price_item js-active-currency">
                      <strong>149 RUR</strong>
                    </span>
                                                          <span data-currency="PLN" data-original-cost="9.28" data-cost="9.28" class="price_item hidden">
                      <strong>9.28 PLN</strong>
                    </span>
                                                          <span data-currency="AZN" data-original-cost="4.33" data-cost="4.33" class="price_item hidden">
                      <strong>4.33 AZN</strong>
                    </span>
                                                                              <span data-currency="KZT" data-original-cost="852.11" data-cost="852.11" class="price_item hidden">
                      <strong>853 KZT</strong>
                    </span>
                                                          <span data-currency="GBP" data-original-cost="1.96" data-cost="1.96" class="price_item hidden">
                      <strong>1.96 GBP</strong>
                    </span>
                                                          <span data-currency="TRY" data-original-cost="9.77" data-cost="9.77" class="price_item hidden">
                      <strong>9.77 TRY</strong>
                    </span>
                                                                                                                                                                                                      <span data-currency="BYN" data-original-cost="5.05" data-cost="5.05" class="price_item hidden">
                      <strong>5.05 BYN</strong>
                    </span>

              </span></label>
                    <a href="javascript:void(0);" class="help-text js-tooltip-text tooltipstered" data-position="bottom"></a>
                </li>
                <li>
                    <input type="checkbox" data-action="avia-additional_services_sms" data-service-label="SMS-уведомление в случае отмены и переноса рейса" checked="checked" data-cost="199" name="sms-flight-cancel-move" value="sms-flight-cancel-move" id="id_sms-flight-cancel-move" class="ui-helper-hidden-accessible">
                    <label for="id_sms-flight-cancel-move" class="ui-state-active ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false"><span class="ui-button-text">
                <svg width="16" height="16">
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox" class="icon-checkbox"></use>
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox1" class="icon-checkbox1"></use>
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox2" class="icon-checkbox2"></use>
                </svg>
                <span>SMS-уведомление в случае отмены и переноса рейса</span>

                                                                          <span data-currency="UAH" data-original-cost="91.85" data-cost="91.85" class="price_item hidden">
                      <strong>92 UAH</strong>
                    </span>
                                                          <span data-currency="USD" data-original-cost="3.40" data-cost="3.40" class="price_item hidden">
                      <strong>3.40 USD</strong>
                    </span>
                                                          <span data-currency="EUR" data-original-cost="2.92" data-cost="2.92" class="price_item hidden">
                      <strong>2.92 EUR</strong>
                    </span>
                                                          <span data-currency="RUR" data-original-cost="199.00" data-cost="199.00" class="price_item js-active-currency">
                      <strong>199 RUR</strong>
                    </span>
                                                          <span data-currency="PLN" data-original-cost="12.40" data-cost="12.40" class="price_item hidden">
                      <strong>12.40 PLN</strong>
                    </span>
                                                          <span data-currency="AZN" data-original-cost="5.78" data-cost="5.78" class="price_item hidden">
                      <strong>5.78 AZN</strong>
                    </span>
                                                                              <span data-currency="KZT" data-original-cost="1138.05" data-cost="1138.05" class="price_item hidden">
                      <strong>1139 KZT</strong>
                    </span>
                                                          <span data-currency="GBP" data-original-cost="2.61" data-cost="2.61" class="price_item hidden">
                      <strong>2.61 GBP</strong>
                    </span>
                                                          <span data-currency="TRY" data-original-cost="13.04" data-cost="13.04" class="price_item hidden">
                      <strong>13.04 TRY</strong>
                    </span>
                                                                                                                                                                                                      <span data-currency="BYN" data-original-cost="6.74" data-cost="6.74" class="price_item hidden">
                      <strong>6.74 BYN</strong>
                    </span>

              </span></label>
                    <a href="javascript:void(0);" class="help-text js-tooltip-text tooltipstered" data-position="bottom"></a>
                </li>
                <li>
                    <input type="checkbox" data-action="avia-additional_services_sms" data-service-label="SMS-билет" data-cost="69" name="sms-ticket" value="sms-ticket" id="id_sms-ticket" class="ui-helper-hidden-accessible">
                    <label for="id_sms-ticket" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false"><span class="ui-button-text">
                <svg width="16" height="16">
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox" class="icon-checkbox"></use>
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox1" class="icon-checkbox1"></use>
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox2" class="icon-checkbox2"></use>
                </svg>
                <span>SMS-билет</span>

                                                                          <span data-currency="UAH" data-original-cost="31.85" data-cost="31.85" class="price_item hidden">
                      <strong>32 UAH</strong>
                    </span>
                                                          <span data-currency="USD" data-original-cost="1.18" data-cost="1.18" class="price_item hidden">
                      <strong>1.18 USD</strong>
                    </span>
                                                          <span data-currency="EUR" data-original-cost="1.01" data-cost="1.01" class="price_item hidden">
                      <strong>1.01 EUR</strong>
                    </span>
                                                          <span data-currency="RUR" data-original-cost="69.00" data-cost="69.00" class="price_item js-active-currency">
                      <strong>69 RUR</strong>
                    </span>
                                                          <span data-currency="PLN" data-original-cost="4.30" data-cost="4.30" class="price_item hidden">
                      <strong>4.30 PLN</strong>
                    </span>
                                                          <span data-currency="AZN" data-original-cost="2.01" data-cost="2.01" class="price_item hidden">
                      <strong>2.01 AZN</strong>
                    </span>
                                                                              <span data-currency="KZT" data-original-cost="394.60" data-cost="394.60" class="price_item hidden">
                      <strong>395 KZT</strong>
                    </span>
                                                          <span data-currency="GBP" data-original-cost="0.91" data-cost="0.91" class="price_item hidden">
                      <strong>0.91 GBP</strong>
                    </span>
                                                          <span data-currency="TRY" data-original-cost="4.52" data-cost="4.52" class="price_item hidden">
                      <strong>4.52 TRY</strong>
                    </span>
                                                                                                                                                                                                      <span data-currency="BYN" data-original-cost="2.34" data-cost="2.34" class="price_item hidden">
                      <strong>2.34 BYN</strong>
                    </span>

              </span></label>
                    <a href="javascript:void(0);" class="help-text js-tooltip-text tooltipstered" data-position="bottom"></a>
                </li>
                <li>
                    <input type="checkbox" data-action="avia-additional_services_sms" data-service-label="Мобильный маршрут" checked="checked" data-cost="249" name="mobile-route" value="mobile-route" id="id_mobile-route" class="ui-helper-hidden-accessible">
                    <label for="id_mobile-route" class="ui-state-active ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false"><span class="ui-button-text">
                <svg width="16" height="16">
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox" class="icon-checkbox"></use>
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox1" class="icon-checkbox1"></use>
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox2" class="icon-checkbox2"></use>
                </svg>
                <span>Мобильный маршрут</span>

                                                                          <span data-currency="UAH" data-original-cost="114.92" data-cost="114.92" class="price_item hidden">
                      <strong>115 UAH</strong>
                    </span>
                                                          <span data-currency="USD" data-original-cost="4.25" data-cost="4.25" class="price_item hidden">
                      <strong>4.25 USD</strong>
                    </span>
                                                          <span data-currency="EUR" data-original-cost="3.65" data-cost="3.65" class="price_item hidden">
                      <strong>3.65 EUR</strong>
                    </span>
                                                          <span data-currency="RUR" data-original-cost="249.00" data-cost="249.00" class="price_item js-active-currency">
                      <strong>249 RUR</strong>
                    </span>
                                                          <span data-currency="PLN" data-original-cost="15.51" data-cost="15.51" class="price_item hidden">
                      <strong>15.51 PLN</strong>
                    </span>
                                                          <span data-currency="AZN" data-original-cost="7.24" data-cost="7.24" class="price_item hidden">
                      <strong>7.24 AZN</strong>
                    </span>
                                                                              <span data-currency="KZT" data-original-cost="1424.00" data-cost="1424.00" class="price_item hidden">
                      <strong>1424 KZT</strong>
                    </span>
                                                          <span data-currency="GBP" data-original-cost="3.27" data-cost="3.27" class="price_item hidden">
                      <strong>3.27 GBP</strong>
                    </span>
                                                          <span data-currency="TRY" data-original-cost="16.32" data-cost="16.32" class="price_item hidden">
                      <strong>16.32 TRY</strong>
                    </span>
                                                                                                                                                                                                      <span data-currency="BYN" data-original-cost="8.44" data-cost="8.44" class="price_item hidden">
                      <strong>8.44 BYN</strong>
                    </span>

              </span></label>
                    <a href="javascript:void(0);" class="help-text js-tooltip-text tooltipstered" data-position="bottom"></a>
                </li>
            </ul>
        </div>


        <div class="extra-item additional_services_ins guarantee_block">
            <img class="extra-img" src="./payment_page_2_files/extra-3.png">
            <h3>Гарантия возврата билета</h3>
            <p>
                Если пассажир по причине болезни не сможет совершить перелет — услуга <a href="https://avia.tickets.ru/content/refund_guarantee.html" target="_blank">«Гарантия возврата в случае болезни»</a> обеспечит возврат полной стоимости билета и отсутствие сервисного сбора за возврат.&nbsp;        </p>


            <ul class="additional_services_list">
                <li>
                    <input type="checkbox" data-action="avia-additional_services_warranty" data-service-label="Гарантия возврата билета" checked="checked" data-cost="999" name="warranty_return_ticket" value="warranty_return_ticket" id="id_warranty_return_ticket" class="ui-helper-hidden-accessible">
                    <label for="id_warranty_return_ticket" class="ui-state-active ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false"><span class="ui-button-text">
                <svg width="16" height="16">
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox" class="icon-checkbox"></use>
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox1" class="icon-checkbox1"></use>
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox2" class="icon-checkbox2"></use>
                </svg>
                <span>Гарантия возврата билета</span>

                                                                          <span data-currency="UAH" data-original-cost="461.08" data-cost="461.08" class="price_item hidden">
                      <strong>462 UAH</strong>
                    </span>
                                                          <span data-currency="USD" data-original-cost="17.06" data-cost="17.06" class="price_item hidden">
                      <strong>17.06 USD</strong>
                    </span>
                                                          <span data-currency="EUR" data-original-cost="14.64" data-cost="14.64" class="price_item hidden">
                      <strong>14.64 EUR</strong>
                    </span>
                                                          <span data-currency="RUR" data-original-cost="999.00" data-cost="999.00" class="price_item js-active-currency">
                      <strong>999 RUR</strong>
                    </span>
                                                          <span data-currency="PLN" data-original-cost="62.24" data-cost="62.24" class="price_item hidden">
                      <strong>62.24 PLN</strong>
                    </span>
                                                          <span data-currency="AZN" data-original-cost="29.04" data-cost="29.04" class="price_item hidden">
                      <strong>29.04 AZN</strong>
                    </span>
                                                                              <span data-currency="KZT" data-original-cost="5713.14" data-cost="5713.14" class="price_item hidden">
                      <strong>5714 KZT</strong>
                    </span>
                                                          <span data-currency="GBP" data-original-cost="13.11" data-cost="13.11" class="price_item hidden">
                      <strong>13.11 GBP</strong>
                    </span>
                                                          <span data-currency="TRY" data-original-cost="65.48" data-cost="65.48" class="price_item hidden">
                      <strong>65.48 TRY</strong>
                    </span>
                                                                                                                                                                                                      <span data-currency="BYN" data-original-cost="33.84" data-cost="33.84" class="price_item hidden">
                      <strong>33.84 BYN</strong>
                    </span>

              </span></label>
                </li>
            </ul>
        </div>


        <div class="extra-item additional_services_ins online_checkin_block">
            <img class="extra-img" src="./payment_page_2_files/extra-8.png">
            <h3>Онлайн-регистрация на рейс</h3>
            <p>
                Сэкономьте время на регистрацию на рейс в аэропорту! Мы сообщим вам о начале онлайн-регистрации на сайте авиакомпании, чтобы вы зарегистрировались самостоятельно, или сделаем это для вас.&nbsp;        </p>


            <ul class="additional_services_list">
                <li>
                    <input type="checkbox" data-action="avia-online_checkin" data-service-label="Зарегистрируйте меня на рейс" data-cost="99" name="online-checkin" value="online-checkin" id="id_online-checkin" class="ui-helper-hidden-accessible">
                    <label for="id_online-checkin" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false"><span class="ui-button-text">
                <svg width="16" height="16">
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox" class="icon-checkbox"></use>
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox1" class="icon-checkbox1"></use>
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox2" class="icon-checkbox2"></use>
                </svg>
                <span>Зарегистрируйте меня на рейс</span>

                                                                          <span data-currency="UAH" data-original-cost="45.69" data-cost="45.69" class="price_item hidden">
                      <strong>46 UAH</strong>
                    </span>
                                                          <span data-currency="USD" data-original-cost="1.69" data-cost="1.69" class="price_item hidden">
                      <strong>1.69 USD</strong>
                    </span>
                                                          <span data-currency="EUR" data-original-cost="1.45" data-cost="1.45" class="price_item hidden">
                      <strong>1.45 EUR</strong>
                    </span>
                                                          <span data-currency="RUR" data-original-cost="99.00" data-cost="99.00" class="price_item js-active-currency">
                      <strong>99 RUR</strong>
                    </span>
                                                          <span data-currency="PLN" data-original-cost="6.17" data-cost="6.17" class="price_item hidden">
                      <strong>6.17 PLN</strong>
                    </span>
                                                          <span data-currency="AZN" data-original-cost="2.88" data-cost="2.88" class="price_item hidden">
                      <strong>2.88 AZN</strong>
                    </span>
                                                                              <span data-currency="KZT" data-original-cost="566.17" data-cost="566.17" class="price_item hidden">
                      <strong>567 KZT</strong>
                    </span>
                                                          <span data-currency="GBP" data-original-cost="1.30" data-cost="1.30" class="price_item hidden">
                      <strong>1.30 GBP</strong>
                    </span>
                                                          <span data-currency="TRY" data-original-cost="6.49" data-cost="6.49" class="price_item hidden">
                      <strong>6.49 TRY</strong>
                    </span>
                                                                                                                                                                                                      <span data-currency="BYN" data-original-cost="3.35" data-cost="3.35" class="price_item hidden">
                      <strong>3.35 BYN</strong>
                    </span>

              </span></label>
                    <a href="javascript:void(0);" class="help-text js-tooltip-text tooltipstered" data-position="bottom"></a>
                </li>
            </ul>
        </div>


    </div>
</section>
<script type="text/javascript">
    var canUseServiceInterface = function(){ return $.hub && $.hub.dispatcher.getManager('service'); };

    var AncillaryServices = function(){
        this.id = 'ancillary';
        this.cost = 0;

        this.name = "AncillaryServices";
        this.mainWrapp = $('#ancillary_service');
        this.selfPrice = 0;
        this.change_by_pas = null;
        this.services = {};
        this.tmp_services = {};
        //this.initEvents(); // @deprecated see init()
        this.pass_seats = {};
        this.stash = {};
        this.current_currency = window.default_currency;
        this.enablePriceInCabinet = false;

        this.services_grouppes = {
            "BG":"Дополнительный багаж",											"SA":"Купить место на борту",					}

        if(canUseServiceInterface()) ServiceInterface.call(this);
    };

    if(canUseServiceInterface()){
        AncillaryServices.prototype = Object.create(ServiceInterface.prototype);
        AncillaryServices.prototype.constructor = AncillaryServices;
    }

    AncillaryServices.prototype.init = function()
    {
        this.initEvents();
    };


    AncillaryServices.prototype.initEvents = function() {
        var _self = this;
        _self.reloadPrice();
    };

    AncillaryServices.prototype.reloadPrice = function() {
        this.reloadCost();
        PriceCalculationObj.reloadPrice();
        //this.notify(); @deprecated
    };

    AncillaryServices.prototype.commit_service = function(service_key) {
        var self = this;
        $.each(self.services, function(k,v){
            var key = k.split("-");
            if(key[4].toLowerCase() == service_key){
                delete self.services[k]
            }
        });
        $.each(this.tmp_services, function(k,v){
            self.services[k] = v
        });
        self.reloadPrice()
    };

    AncillaryServices.prototype.update_ordered_seat_map = function(){
        var self = this;
        self.pass_seats = {};
        $.each(self.services, function(k,v){
            var key = k.split("-");
            if(key[4].toLowerCase() == "sa"){
                self.pass_seats[k] = {"seat": v["add_info"], "costs":v["costs"]}
            }
        });
        self.update_seat_map();
    };
    AncillaryServices.prototype.update_seat_map = function(){
        var self = this;
        $("#sa_popup").find(".popup__footer").find(".total_service_cost").text(0);
        $(".plane_scheme_ins").find(".icon-hyundai-seat-back").removeClass("checked");
        $(".plane_scheme_ins").find(".icon-hyundai-seat-back").text("");
        $(".choosen_seat").text("-");
        var flt_total = 0;
        $.each(self.pass_seats, function(v,k){
            arr_data = v.split("-");
            pass = parseInt(arr_data[0]);
            segment = $("#" + arr_data[1] + "-" + arr_data[2] + "-" + arr_data[3] + "-" + arr_data[4]);
            segment.find("label[for=pass_"+pass+"]").find(".choosen_seat").text(k["seat"]);
            pass_txt = parseInt(segment.find("label[for=pass_"+pass+"]").attr("pass_index"));
            pass_txt += 1;
            elem = segment.find("#" + k["seat"]);
            elem.text(pass_txt);
            elem.addClass("checked");
            self.add_tmp_service(v, {"cost" : k["costs"][self.get_currency()], "currency" : self.get_currency(), "add_info" : k["seat"], "costs": k["costs"] })
            flt_total += k["costs"][self.get_currency()];
        });
        $("#sa_popup").find(".popup__footer").find(".total_service_cost").text(flt_total);
        $("#sa_popup").find(".popup__footer").find(".ancillary_service_currency").text(self.get_currency());
    };

    AncillaryServices.prototype.update_costs = function(category){
        var self = this;
        c_currency = self.get_currency();
        $.each($('#' + category + '_popup').find(".add-service"), function(){
            $(this).find(".service_cost").text( $(this).attr("data-price_" + c_currency) );
            $(this).find(".service_currency").text( c_currency );
        });

        $('#' + category + '_popup').find(".total_service_currency").text(c_currency);

        total_cost = 0.00;
        $.each(this.services, function(k,v){
            var key = k.split("-");
            if( key[4].toLowerCase() == category){
                total_cost += v['costs'][c_currency]
            }
        });
        $('#' + category + '_popup').find(".total_service_cost").text(total_cost);


    };

    AncillaryServices.prototype.bind_service = function(bind_key) {
        var self = this;
        $.each(this.services, function(k,v){
            var key = k.split("-");
            if(bind_key != key[4].toLowerCase()){
                return;
            }

            if(bind_key == "sa"){
                /**
                 * seat map have different logic
                 */
                $("#sa_popup").find(".js--accordeon-item:first").find(".js--accordeon-item__content").show();
                //self.update_seat_map();

            }else{
                $('.add-service input[data-index="'+k+'"]').iCheck('check');
                if( self.change_by_pas != null && self.change_by_pas != key[0] ){
                    return;
                }
                $("#"+key[4].toLowerCase()+"_popup").find(".popup__title.pass_"+key[0]).closest(".js--accordeon-item").find(".js--accordeon-item__content").show();
            }



            // $('.add-service input[data-index="'+k+'"]').iCheck('check');
            // if( self.change_by_pas != null && self.change_by_pas != key[0] ){
            // 	return;
            // }

            // $("#"+key[4].toLowerCase()+"_popup").find(".popup__title.pass_"+key[0]).closest(".js--accordeon-item").find(".js--accordeon-item__content").show();
        });

        if(bind_key == "sa" && Object.getOwnPropertyNames(this.services).toString().indexOf("SA") < 0  ) {
            $("#sa_popup").find(".js--accordeon-item:first").find(".js--accordeon-item__content").show();
            $("#sa_popup").find(".js--accordeon-item").find("input[name^='passenger_seat']:first").iCheck('check');
        }

        switch(bind_key) {
            case "bg":
                this.update_costs("bg");
                break;
            case "ml":
                this.update_costs("ml");
                break;
            case "sa":
                self.update_ordered_seat_map();
        }
        // if(bind_key == "bg"){
        //     this.update_costs("bg")
        // }

        // if(bind_key == "sa"){
        //     self.update_ordered_seat_map();
        // }

        this.change_by_pas = null;
    };

    AncillaryServices.prototype.remove_service = function(int_key) {
        delete this.services[int_key];
    };

    AncillaryServices.prototype.clear_tmp_service = function(int_key) {
        var self = this;
        $("#"+int_key+"_popup").find('.add-service input').iCheck('uncheck');
        if($("#"+int_key+"_popup").find(".popup__title").closest(".js--accordeon-item").find(".js--accordeon-item__content").is(":visible")){
            $("#"+int_key+"_popup").find(".popup__title").closest(".js--accordeon-item").find(".js--accordeon-item__content").hide();
        }

        $("#"+int_key+"_popup").find(".popup__footer").find(".total_service_cost").text(0.00);
    };

    AncillaryServices.prototype.add_tmp_service = function(int_key, data) {
        this.tmp_services[int_key] = data
    };

    //	  AncillaryServices.prototype.subscribers = [];
    //	  AncillaryServices.prototype.notify = function(){
    //	    var self = this;
    //	    this.subscribers.forEach(function(subscriber){
    //	      subscriber.updateService(self);
    //	    });
    //	  };
    //	  AncillaryServices.prototype.addSubscriber = function(subscriber){
    //	    if(typeof subscriber.updateService === 'function'){
    //	      this.subscribers.push(subscriber);
    //	    }else{
    //	      console.warn("subscriber doesn't provide updateService method");
    //	    }
    //	  };

    AncillaryServices.prototype.remove_tmp_service = function(int_key) {
        delete this.tmp_services[int_key]
    };
    AncillaryServices.prototype.changeCurrency = function(currency) {
        this.current_currency = currency;
        this.reloadPrice();
    };

    AncillaryServices.prototype.get_currency = function() {
        // ctrl = $(".payment_block").controller();
        // var currency;
        // if( ctrl !== undefined ){
        //     currency = ctrl.cost.getActivePaymentSystem().getCurrency();
        // }
        return this.current_currency;
    };

    AncillaryServices.prototype.reloadCost = function() {

        var services_cost = 0;
        var services_form = [];
        var self = this;
        $.each(this.services, function(k,v){
            cost = v["cost"]
            if( typeof v["costs"] !== "undefined"){
                cost = v["costs"][self.get_currency()]
            }
            services_cost += cost;
            if( typeof v["add_info"] != "undefined"){
                k += "-" + v["add_info"]
            }
            services_form.push(k);
        });

        $("input[name=ancillary_service]").val(services_form.join("_"));

        var arr_groupped_services = {};
        var currency;
        $.each(this.services, function(k,v){
            var arr_key = k.split("-");
            currency = v["currency"];
            if( typeof arr_groupped_services[arr_key[0]] === "undefined"){
                arr_groupped_services[arr_key[0]] = {}
            }
            if( typeof arr_groupped_services[arr_key[0]][arr_key[4]] === "undefined"){
                arr_groupped_services[arr_key[0]][arr_key[4]] = 0
            }
            cost = v["cost"];
            if( typeof v["costs"] !== "undefined" ){
                cost = v["costs"][self.get_currency()];
            }
            arr_groupped_services[arr_key[0]][arr_key[4]] += cost;
        });


        html = self.getHtml(arr_groupped_services);
        $("#ancillary_service div.details").html(html);
        this.selfPrice = services_cost;
        this.allowNotify(true);
        this.setCost(services_cost);

    };
    AncillaryServices.prototype.getHtml = function(arr_groupped_services) {
        var self = this;
        html = "";
        $.each(arr_groupped_services, function(k,obj){
            var n = k;
            n++;
            html += "<div class='popup__table-separator'></div><div class='popup__table-header'><div class='col-12'><strong>Для пассажира "+n+"</strong></div></div>";

            $.each(obj, function(i, v){
                html += '<div class="popup__table-row">';
                html += '<div class="col-8">'+self.services_grouppes[i]+'</div>';
                html += '<div class="col-2"><div class="popup__title--sub">'+v+' '+self.get_currency()+'</div></div>';
                html += '<div class="col-2 text-right"><a href="#" class="popup__table-link" data-link="'+i.toLowerCase()+'" onclick="open_w(this,'+k+')">Редактировать</a></div>';
                html += '</div>';
            })
        });
        return html;
    };

    AncillaryServices.prototype.save_service_click = function(service_key, vs) {
        var log_data = {
            ancillary_category: service_key.toUpperCase(),
            validating_supplier: vs,
            session_id: window.session_id,
            recommendation_id: window.recommendation_id,
            route: 'IEV LON'
        };
        window.klog(1200, JSON.stringify(log_data), window.session_id);
    };

    AncillaryServices.prototype.stash_services = function(status) {
        var self = this;
        if(status == "save"){
            self.stash = $.extend(true, {}, self.services);
            $.each(self.services, function(k,v){
                var bind_key = k.split("-")[4].toLowerCase();
                self.clear_tmp_service(bind_key);
            });
            self.services = {};
        };
        if(status == "apply"){
            self.services = $.extend(true, {}, self.stash);
            self.stash = {};
            $.each(self.services, function(int_key,v){
                self.bind_service(int_key);
            });
            self.update_seat_map();
        };
        self.reloadCost();
    };

    function open_w(obj, pass){
        ancillaryServicesObj.change_by_pas = pass;
        $(".js-popup-link[href='#"+$(obj).attr("data-link")+"_popup']").click()
    }

    ancillaryServicesObj = new AncillaryServices;

    if(canUseServiceInterface()){
        $.hub.dispatcher.getManager('service').add(ancillaryServicesObj);
    }else{
        PriceCalculationObj.addService(ancillaryServicesObj);
        ancillaryServicesObj.init();
        console.warn('This is DEPRECATED! Use ServiceInterface instead');
    }

</script>
<!-- ANCILLARY -->
<script type="text/javascript">
    AncillaryServices.prototype.getHtml = function(arr_groupped_services) {
        var self = this,
            total = {};

        $('[id *= "addP_ancillary_"]').remove();
        $('.additional-service__onboard [class *= "js-total-price-"]').text('0 ' + self.get_currency());

        $.each(arr_groupped_services, function(k,obj){
            var n = k;
            n++;
            var pass =  'Для пассажира ' + n;
            $.each(obj, function(i, v){
                var text = self.services_grouppes[i] + ' ' + pass.toLowerCase();
                var id = 'ancillary_' +  i.toLowerCase() + '_pass_' + n;
                html = '<div class="col-2 col-xl-4 col-l-2 col-m-12""><a href="#" class="popup__table-link" data-link="'+i.toLowerCase()+'" onclick="open_w(this,'+k+')">Редактировать</a></div>';
                $.hub.dispatcher.getManager('payment').additionalPricesSet(id, text, v);

                if(!total[i.toLowerCase()]) total[i.toLowerCase()] = 0;
                total[i.toLowerCase()] += v;
            })
            $.each(total, function(i, v){
                $('.js-total-price-'+i.toLowerCase()).html(v + ' ' + self.get_currency());
            });

        });
        return '';
    }
</script>
<!-- INSURANCE -->
<script type="text/javascript">
    var canUseServiceInterface = function(){ return $.hub && $.hub.getManager('service'); };
    var InsuranceWithAvia = function(){
        this.id = 'insurance';
        this.cost = 0;
        this.mainWrapp          = $('.insurance-block');
        this.loader             = $('.b_preloader', this.mainWrapp);
        this.policiesList       = $('.insurance-block__item', this.mainWrapp);
        this.insuranceOptions   = $('#insurance_options');
        this.insuranceWithAvia  = $('#insurance_with_avia');
        this.oferta             = $('.insurance_oferta');
        this.selfPrice          = 0;
        this.currencies         = {"AED":"AED","AFN":"AFN","ALL":"ALL","AMD":"AMD","ANG":"ANG","AOA":"AOA","ARS":"ARS","AUD":"AUD","AWG":"AWG","AZM":"AZM","AZN":"AZN","BAM":"BAM","BBD":"BBD","BDT":"BDT","BGN":"BGN","BHD":"BHD","BIF":"BIF","BMD":"BMD","BND":"BND","BOB":"BOB","BRL":"BRL","BSD":"BSD","BTN":"BTN","BWP":"BWP","BYN":"BYN","BYR":"BYR","BZD":"BZD","CAD":"CAD","CDF":"CDF","CHF":"CHF","CLP":"CLP","CNY":"CNY","COP":"COP","CRC":"CRC","CUC":"CUC","CUP":"CUP","CVE":"CVE","CZK":"CZK","DJF":"DJF","DKK":"DKK","DOP":"DOP","DZD":"DZD","EEK":"EEK","EGP":"EGP","ERN":"ERN","ETB":"ETB","EUR":"EUR","FJD":"FJD","FKP":"FKP","GBP":"GBP","GEL":"GEL","GGP":"GGP","GHS":"GHS","GIP":"GIP","GMD":"GMD","GNF":"GNF","GTQ":"GTQ","GYD":"GYD","HKD":"HKD","HNL":"HNL","HRK":"HRK","HTG":"HTG","HUF":"HUF","IDR":"IDR","ILS":"ILS","IMP":"IMP","INR":"INR","IQD":"IQD","IRR":"IRR","ISK":"ISK","JEP":"JEP","JMD":"JMD","JOD":"JOD","JPY":"JPY","KES":"KES","KGS":"KGS","KHR":"KHR","KMF":"KMF","KPW":"KPW","KRW":"KRW","KWD":"KWD","KYD":"KYD","KZT":"KZT","LAK":"LAK","LBP":"LBP","LKR":"LKR","LRD":"LRD","LSL":"LSL","LTL":"LTL","LVL":"LVL","LYD":"LYD","MAD":"MAD","MDL":"MDL","MGA":"MGA","MKD":"MKD","MMK":"MMK","MNT":"MNT","MOP":"MOP","MRO":"MRO","MUR":"MUR","MVR":"MVR","MWK":"MWK","MXN":"MXN","MYR":"MYR","MZN":"MZN","NAD":"NAD","NGN":"NGN","NIO":"NIO","NOK":"NOK","NPR":"NPR","NZD":"NZD","OMR":"OMR","PAB":"PAB","PEN":"PEN","PGK":"PGK","PHP":"PHP","PKR":"PKR","PLN":"PLN","PYG":"PYG","QAR":"QAR","RON":"RON","RSD":"RSD","RUB":"RUR","RUR":"RUR","RWF":"RWF","SAR":"SAR","SBD":"SBD","SCR":"SCR","SDG":"SDG","SDR":"SDR","SEK":"SEK","SGD":"SGD","SHP":"SHP","SLL":"SLL","SOS":"SOS","SPL":"SPL","SRD":"SRD","SSP":"SSP","STD":"STD","SVC":"SVC","SYP":"SYP","SZL":"SZL","THB":"THB","TJS":"TJS","TMM":"TMM","TMT":"TMT","TND":"TND","TOP":"TOP","TRL":"TRL","TRY":"TRY","TTD":"TTD","TVD":"TVD","TWD":"TWD","TZS":"TZS","UAH":"UAH","UGX":"UGX","USD":"USD","UYU":"UYU","UZS":"UZS","VEF":"VEF","VND":"VND","VUV":"VUV","WST":"WST","XAF":"XAF","XAG":"XAG","XAU":"XAU","XCD":"XCD","XDR":"XDR","XOF":"XOF","XPD":"XPD","XPF":"XPF","XPT":"XPT","YER":"YER","ZAR":"ZAR","ZMK":"ZMK","ZWD":"ZWD","ZWL":"ZWL"};
        this.running_request = false;
        this.lang               = (lang_prefix || 'ru').replace('/', '');
        this.useCostPerPassenger = 1;
        this.passengerCount     = 1 ;
        this.session_id =  '996f9eca20cc3521c9b72d27bb00cbd6';
        this.recommendation_id =  'c226c33e5d2533608ad70ff070ababc8_21^^0';
        this.is_booking         = 0;
        this.recommendation = [{"id":"c226c33e5d2533608ad70ff070ababc8_21","duration":400,"stopsCount":2,"maxStopsCount":-1,"segments":[{"elementRef":null,"carrierNumber":"34","otherCarrierNumber":null,"departureTime":1513054800,"arrivalTime":1513059000,"supplier":"UIA","otherSupplier":"UIA","supplierIATA":"PS","otherSupplierIATA":"PS","aircraftAge":null,"bCity":"LWO","bCityIATA":"LWO","bCountry":"UA","bCountryIATA":"UA","bLocation":"LWO","bLocationIATA":"LWO","bTerminal":"","eCity":"IEV","eCityIATA":"IEV","eCountry":"UA","eCountryIATA":"UA","eLocation":"KBP","eLocationIATA":"KBP","eTerminal":"","aircraft":"Boeing 737-800","aircraftCode":"738","rbd":"Q","rbd_type":"economy","segmentStopsCount":null,"segmentStopsList":"","status":"9","bookingClass":"M","amount":null,"fic":null,"flightTime":70,"cabin":null,"baggage":"1N","meals":"","fare_code":"QOWUIA","designator":null,"stops":[],"e_ticket":null,"operating_supplier":null,"availSource":"","key":"","departureTimeRaw":null,"arrivalTimeRaw":null,"marriageType":null,"baggage_segment_index":-1,"baggage_reference_number":-1,"baggage_flight_index":-1,"corporate_id":"","break_point":null},{"elementRef":null,"carrierNumber":"889","otherCarrierNumber":null,"departureTime":1513064700,"arrivalTime":1513072200,"supplier":"UIA","otherSupplier":"UIA","supplierIATA":"PS","otherSupplierIATA":"PS","aircraftAge":null,"bCity":"IEV","bCityIATA":"IEV","bCountry":"UA","bCountryIATA":"UA","bLocation":"KBP","bLocationIATA":"KBP","bTerminal":"","eCity":"MSQ","eCityIATA":"MSQ","eCountry":"BY","eCountryIATA":"BY","eLocation":"MSQ","eLocationIATA":"MSQ","eTerminal":"","aircraft":"Boeing 737-800","aircraftCode":"738","rbd":"Q","rbd_type":"economy","segmentStopsCount":null,"segmentStopsList":"","status":"9","bookingClass":"M","amount":null,"fic":null,"flightTime":65,"cabin":null,"baggage":"1N","meals":"","fare_code":"QOWUIA","designator":null,"stops":[],"e_ticket":null,"operating_supplier":null,"availSource":"","key":"","departureTimeRaw":null,"arrivalTimeRaw":null,"marriageType":null,"baggage_segment_index":-1,"baggage_reference_number":-1,"baggage_flight_index":-1,"corporate_id":"","break_point":null},{"elementRef":null,"carrierNumber":"836","otherCarrierNumber":null,"departureTime":1513077600,"arrivalTime":1513082400,"supplier":"UTair","otherSupplier":"UTair","supplierIATA":"UT","otherSupplierIATA":"UT","aircraftAge":null,"bCity":"MSQ","bCityIATA":"MSQ","bCountry":"BY","bCountryIATA":"BY","bLocation":"MSQ","bLocationIATA":"MSQ","bTerminal":"","eCity":"MOW","eCityIATA":"MOW","eCountry":"RU","eCountryIATA":"RU","eLocation":"VKO","eLocationIATA":"VKO","eTerminal":"A","aircraft":"Boeing 737-500","aircraftCode":"735","rbd":"K","rbd_type":"economy","segmentStopsCount":null,"segmentStopsList":"","status":"9","bookingClass":"M","amount":null,"fic":null,"flightTime":80,"cabin":null,"baggage":"1N","meals":"","fare_code":"QOWUIA","designator":null,"stops":[],"e_ticket":null,"operating_supplier":null,"availSource":"","key":"","departureTimeRaw":null,"arrivalTimeRaw":null,"marriageType":null,"baggage_segment_index":-1,"baggage_reference_number":-1,"baggage_flight_index":-1,"corporate_id":"","break_point":null}],"amount":{"UAH":6730.14,"USD":249.07,"EUR":213.75,"RUR":14582,"PLN":908.54,"AZN":423.89,"MDL":null,"KZT":83392.43,"GBP":191.36,"TRY":955.76,"RON":null,"BYR":null,"DKK":null,"NOK":null,"SEK":null,"CHF":null,"AED":null,"BYN":494.01,"CAD":null,"KGS":null,"AMD":null,"UZS":null,"AUD":null,"MXN":null,"GEL":null},"base_amount":{"UAH":6730},"start_amount":{"UAH":6730.14,"USD":249.07,"EUR":213.75,"RUR":14582,"PLN":908.54,"AZN":423.89,"MDL":null,"KZT":83392.43,"GBP":191.36,"TRY":955.76,"RON":null,"BYR":null,"DKK":null,"NOK":null,"SEK":null,"CHF":null,"AED":null,"BYN":494.01,"CAD":null,"KGS":null,"AMD":null,"UZS":null,"AUD":null,"MXN":null,"GEL":null},"service_amount":{"UAH":0,"USD":0,"EUR":0,"RUR":0,"PLN":0,"AZN":0,"MDL":null,"KZT":0,"GBP":0,"TRY":0,"RON":null,"BYR":null,"DKK":null,"NOK":null,"SEK":null,"CHF":null,"AED":null,"BYN":0,"CAD":null,"KGS":null,"AMD":null,"UZS":null,"AUD":null,"MXN":null,"GEL":null},"payment_amount":null,"partner_commission":{"UAH":0,"USD":0,"EUR":0,"RUR":0,"PLN":0,"AZN":0,"MDL":null,"KZT":0,"GBP":0,"TRY":0,"RON":null,"BYR":null,"DKK":null,"NOK":null,"SEK":null,"CHF":null,"AED":null,"BYN":0,"CAD":null,"KGS":null,"AMD":null,"UZS":null,"AUD":null,"MXN":null,"GEL":null},"amountWithoutTax":3127,"tax":3603,"taxes":null,"fee":"","isFeeIncluded":true,"currency":"UAH","ticketingTimeLimit":"","ticketingTimeLimitBackend":"","page_ticket":-1,"hash":"","route_hash":null,"showInList":true,"currencyName":"","bookingClass":"","bookingFreeSeats":"9","validatingSupplier":"PS","index":0,"system_id":21,"gds_id":null,"gds_name":"amadeus","office_id":null,"amounts":"{\"total_amount\":6730.0,\"ADT\":{\"amt\":6730.0,\"taxes\":3603.0,\"tarif\":\"UAH 3127.0\",\"equiv\":3127.0,\"amt_wcf\":6730.0},\"CHD\":{},\"INF\":{},\"currency\":\"UAH\",\"special_type\":false,\"card_fee\":0.0}","card_allowed":false,"validatingSupplierName":null,"baggage_rules":"","allowed_validating_suppliers":"PS,UT,HR","is_corporate":null,"commission_reward":0,"bsp_commission":null,"depot_commission":null,"latin_registration":null,"pay_system_commission":null,"is_multi":false,"is_lcc":false,"is_passport_required":true,"multi_id":null,"bsp_country":"UA","lcc_amount":"","lcc_start_amount":"","lcc_base_amount":"","lcc_partner_commission":"","is_mixed_fp":false,"multi_info":null,"repriced":false,"main_el":"","subelement":"","is_agent_forbidden":null,"instance_ticketing":false,"mt_data":null,"pcc":null,"cross_config_pricing":null,"fare_family":"","used_value_search":false,"payment_before_booking":null,"has_special_fare":false,"lcc_charge_data":null,"lcc_hide_label":null,"source":null,"ancillary_services":null}];
        this.cabinet_panel      = $('.extra_add');
        this.use_popup_info = 0;
        this.load_form = false;
        if(canUseServiceInterface()) ServiceInterface.call(this);

    };

    if(canUseServiceInterface()){
        InsuranceWithAvia.prototype = Object.create(ServiceInterface.prototype);
        InsuranceWithAvia.prototype.constructor = InsuranceWithAvia;
    }
    InsuranceWithAvia.prototype.init = function () {
        this.loadLivePrice();
    }
    InsuranceWithAvia.prototype.checkboxes = function(){
        return $('input[type=checkbox]', this.mainWrapp);
    }

    InsuranceWithAvia.prototype.checkDefaultCheckboxes = function(checked){
        var _self = this, any = false;
        for(var i = 0; i< checked.length; i++){
            _self.checkboxes().filter('[data-packet="'+checked[i]+'"]').prop('checked',true).button('refresh');
            _self.checkboxes().filter('[data-packet="'+checked[i]+'"][data-provider="lis"]').closest('tr').addClass('active-packet');
            if(_self.checkboxes().filter('[data-packet="'+checked[i]+'"]').length){
                any = true;
            }
        }
        return any;
    }

    InsuranceWithAvia.prototype.checkDefault = function(checked_packets){
        if(this.is_booking) return false;
        var _self = this;
        if(checked_packets){
            _self.checkDefaultCheckboxes(checked_packets);
            _self.reloadPrice();
        }
    }

    InsuranceWithAvia.prototype.initEvents = function(live){
        var _self = this;

        $('input[name*=birthday]').change(function(ev){
            if($('input[name*=birthday_day]').length){
                var index = $(this).prop('name').match(/\d+/)[0];
                var inputs = $('[id^="birthday_"][name^="passengers['+index+']"]');
                var filtered = inputs.filter(function (i,obj) { return obj.value != '' });
                if(filtered.length == 3 && inputs.valid()){
                    _self.loadLivePrice();
                }
            } else {
                if($(ev.currentTarget).valid()){
                    _self.loadLivePrice();
                }
            }
        })

//    if( this.mainWrapp.find('.continue').length > 0 ){
//      this.mainWrapp.find('.continue').on('click',function(ev){
//        ev.preventDefault();
//        _self.alertMsg($(this).closest('.info_popup'), 'hide');
//      })
//    }

        if(_self.is_booking) {
            $('#order_form_cabinet').prepend(_self.mainWrapp.find('input[type=hidden]'));
            $('#order_form_cabinet').on('submit',function(){
                window.show_globus_loader();
            });
        }

        this.checkboxes().on('change', function(ev){
            ev.preventDefault();
            var el = $(this);
//      _self.mainWrapp.find('.info_popup').addClass('hidden');

            if(_self.is_booking && _self.checkboxes().filter(':checked').not(el).first().data('provider') != el.data('provider')){
                _self.checkboxes().not(el).prop('checked',false).button('refresh');
            }
//      if( !el.is(':checked') && _self.use_popup_info ){
//        _self.alertMsg(el.closest('.additional-insurance__item').find('.info_popup'), 'show', el);
//      }

            _self.reloadPrice();
        })

//    $(document).on('click','input[data-provider="lis"]',function (e) {
//      var line = $(e.target).closest('tr')
//      if($(e.target).is(':checked')){
//        line.addClass('active-packet')
//      } else {
//        line.removeClass('active-packet')
//      }
//    })

        $(document).on('click', '.insurance-block__item-package .price', function (e) {
            $(e.target).closest('.grid-small').find('input[type="checkbox"]').click()
        });

        _self.reloadPrice();
    }

    //  InsuranceWithAvia.prototype.alertMsg = function(el, action, checkbox){
    //    var checkbox = checkbox || false;
    //    switch (action) {
    //      case 'show':
    //        var self = this;
    //        self.mainWrapp.find('.info_popup').addClass('hidden');
    //        el.removeClass('hidden');
    //        checkbox.prop('checked',true).button('refresh');
    //        var curr_denial = checkbox.closest('.additional-insurance__item').find('.denial');
    //        curr_denial.bind('click.uncheck',function(ev){
    //          ev.preventDefault();
    //          checkbox.prop('checked',false).button('refresh');
    //          self.selectedIndex = -1;
    //          self.reloadPrice();
    //          curr_denial.unbind('click.uncheck');
    //          self.mainWrapp.find('.info_popup').addClass('hidden');
    //        })
    //        break
    //      case 'hide':
    //        this.mainWrapp.find('.info_popup').addClass('hidden');
    //        break
    //    }
    //    return false;
    //  }

    InsuranceWithAvia.prototype.reloadCost = function(){
        var insurance_cost = 0
            , with_insurance = false
            , ids = []
            , _self = this
            , selected_insurance_services = [];

        $('.booking_price_button').find('ins').hide();
        var currency = default_currency;
        if($.hub.getManager('payment')){
            currency = $.hub.getManager('payment').getActivePaymentSystem().getCurrency();
        }
//    this.changeCurrency(currency);
        var provider_packets = {}
        this.checkboxes().each(function(i, ch){
            el = $(ch);
            var packet_block = el.closest('.packet_block');
            packet_block.find('.policies_price').addClass('hidden').hide();

            var selected = packet_block.find('.policies_price[data-currency='+currency+']');
            selected.removeClass('hidden').show();

            use_real_cost_for = ['cancel_travel', 'schengen_t1', 'russia_t3', 'finland_t1', 'europa_t1', 'world_t2', 'cancel_travel_fullworld_ru'].indexOf(el.data('keys')) != -1;
            if( el.is(':checked') ){
                with_insurance = true;
                insurance_cost += parseFloat(String(selected.data('cost')).replace(' ', ''));
                insurance_cost = window.ceilNumber(insurance_cost,0);
                var provider_name = el.data('provider');
                if(!provider_packets[provider_name]) {
                    provider_packets[provider_name] = {packets: [], cost: 0.0, packets_info: [] };
                }
                var packet = el.data('keys');
                provider_packets[provider_name].packets = provider_packets[provider_name].packets.concat(packet.split(','));
                provider_packets[provider_name].cost += parseFloat(String(selected.data('cost')).replace(' ', ''));
                provider_packets[provider_name].packets_info = provider_packets[provider_name].packets_info.concat({ packet: packet, price: parseFloat(String(selected.data('cost')).replace(' ', ''))});
            }
        })
        $.each(provider_packets, function(index, value) {
            ids.push({packets: value.packets, provider_name: index});
        });

        this.insuranceWithAvia.val(with_insurance*1);
        if( with_insurance ){
            this.insuranceOptions.val();
            this.insuranceOptions.val( JSON.stringify(ids) );
            $('.booking_price_button').find('ins').show();
            window.enable_magnific();
        }
        var price = insurance_cost;
        if( this.useCostPerPassenger && with_insurance ){
            var full_cost_arr = $('.policies_price:not(.hidden):first').text().split(" ");
            var cur = full_cost_arr[full_cost_arr.length - 1];
            if(cur == $('.way_th').data('default-currency')){
                price = window.formatNumber(price, $('.way_th').data('decimal-precision'));
            }else{
                price = window.formatNumber(price, $('.way_th').data('decimal-precision-other-currency'));
            }
            if(this.is_booking){
                this.mainWrapp.find('.pay-order_insurance strong').text(price+' '+cur);
                this.mainWrapp.find('.pay-order_insurance').removeClass('hidden');
            } else {
                this.mainWrapp.find('.pay-order_insurance').addClass('hidden');
                this.mainWrapp.find('.additional-insurance__total span').text(price+' '+cur);
                this.mainWrapp.find('.additional-insurance__total').removeClass('hidden');
            }
        } else {
            this.mainWrapp.find('.additional-insurance__total').addClass('hidden');
            this.mainWrapp.find('.pay-order_insurance').addClass('hidden');
        }
        if(!_self.is_booking) {
            try {
                $.hub.getManager('payment').additionalPricesSet('ins_with_avia', 'Стоимость страховки', price)
            }
            catch (e) {
                token = $.cookie("extended_user_token").replace(/[^0-9]/gi,'');
                token = token ? token : ((typeof(session_id)!="undefined" ? session_id : "")||'');
                window.log_error(JSON.stringify(e), token , (window.location.pathname) , 40008);
            }
        }

        this.selfPrice = insurance_cost;
        if(canUseServiceInterface()){
            this.setCost(insurance_cost);
        }
        if (this.selfPrice > 0) {
            selected_insurance_services.push({'label': 'Страховка', 'price': this.selfPrice});
        }

        if (typeof avia_sub_total != 'undefined') {
            avia_sub_total.add_service('insuranse_services', selected_insurance_services);
            avia_sub_total.reload();
        }
    }
    InsuranceWithAvia.prototype.changeCurrency = function (currency) {
        this.showElWithCurrency(currency, $('.insurance-block .policies_price'));
        this.reloadCost();
    }
    InsuranceWithAvia.prototype.showElWithCurrency = function(currency, els) {
        $.each(els, function(index, el) {
            if($(el).data('currency') == currency) {
                $(el).removeClass('hidden').show();
            } else {
                $(el).addClass('hidden').hide();
            }
        })
    }
    InsuranceWithAvia.prototype.toggleService = function (bool) {
        if(Boolean(bool)){
            this.insuranceWithAvia.val(1);
            this.mainWrapp.show();
            this.reloadPrice();
        } else {
            this.hideIfError();
        }
    }
    InsuranceWithAvia.prototype.reloadPrice = function() {
        this.allowNotify(true);
        this.reloadCost();
    }

    InsuranceWithAvia.prototype.loadAges = function(){
        var dates = [];
        if(this.is_booking){
            $.each(this.recommendation.passengers,function(index,value){
                var date = new Date(value.birthday*1000);
                dates.push(date.getDate()+'.'+(date.getMonth()+1)+'.'+date.getFullYear());
            })
        } else {
            if($('input[name*=birthday_day]').length){
                $.each($('input[name*=birthday_day]'), function(index,value){
                    var date_arr = Object.values($.parseParams($('input[name*=birthday][id$="_'+index+'"]').serialize()));
                    dates.push(date_arr.join('.'));
                })
            } else {
                $('input[name*=birthday]').each(function () {
                    dates.push($(this).val());
                });
            }
        }
        return dates;
    }

    InsuranceWithAvia.prototype.loadLivePrice = function(){
        if (this.running_request) return false;
        this.running_request = true;
        var _self = this,
            data = {
                insurance_provider: 'mixed',
                session_id: _self.session_id,
                recommendation_id: _self.recommendation_id,
                translate_inside: true,
                passengers_count: _self.passengerCount,
                is_domestic: false,
                'detail': {
                    date_from: "12.12.2017",
                    date_to: "12.12.2017",
                    ow: "true",
                    trip_cost: "ADT:14582.00",
                    coverage: '["transfer","T-III"]',
                    version: 2,
                    require_docs: true,
                    ages: JSON.stringify(this.loadAges())
                }
            };
        if(_self.is_booking){
            data.recommendation = _self.recommendation;
        }
        this.load_form = false;
        if(this.ajax) { this.ajax.abort(); }
        this.ajax = $.ajax({
            url: "insurance",
            type: "POST",
            data: data,
            dataType: "json",
            beforeSend: function(){
                $('.booking_price_button').find('ins').hide();
                _self.cabinet_panel.hide()
                _self.loader.show();
            },
            success: function(data){
                if( data.error ){
                    _self.mainWrapp.hide();
                } else {
                    _self.cabinet_panel.show();
                    _self.loader.hide();
                    _self.fillData(data);
                    _self.checkDefault(data.checked_packets);
                    _self.initEvents(true);
                }
                _self.load_form = true;
            },
            complete: function () {
                _self.running_request = false;
                //_self.checkDefault();
            },
            fail: function(){
                _self.hideIfError();
            },
            error: function(){
                _self.hideIfError();
            }
        })
    }
    InsuranceWithAvia.prototype.checkContent = function () {
        var dataProviders = [],
            _self = this;
        _self.oferta.html('');
        $('input[data-provider]').each(function () {
            var provider = $(this).data('provider');
            if(dataProviders.indexOf(provider) == -1){
                dataProviders.push(provider);
                _self.checkOferta(provider);
            }
        })
        $('[data-content]').hide()
        dataProviders.forEach(function (v) {
            $('[data-content='+v+']').show().prop('class','col-6 col-m-12');
        })
        if(dataProviders.length == 1){
            $('[data-content='+dataProviders[0]+']').prop('class','col-12');
        }
    }

    InsuranceWithAvia.prototype.checkOferta = function (provider) {
        var provider_oferta = {'lis':'<a href="https://avia.tickets.ru/content/erv-insurance-conditions.html" class="js-magnific-link" >условия страхования от ЕРВ</a>',
                'cherehapa':'<a href="https://avia.tickets.ru/content/air-insurance-offer-ingos.html" class="tariff_rules_all js-magnific-link" >условия договора оферты страхования на время перелета</a>'},
            _self = this;

        //_self.oferta.hide();
        _self.oferta.append(', ' + provider_oferta[provider]);
        _self.oferta.show();
    }

    InsuranceWithAvia.prototype.fillData = function(data){
        var packets = data.products,
            _self = this;
        this.policiesList.find('.insurance-block__item-package').remove();
        var cost_info = '';
        var packet_with_full_cost = ['1421963','schengen_t1','russia_t3','finland_t1','europa_t1','world_t2', 'cancel_travel_fullworld_ru'];
        $('#insurance_session_id').val(data.insurance_session_id);
        $.each(packets, function (i, packet) {
            var use_full_cost = $.inArray(packet.id, packet_with_full_cost) != -1;
            var prices = '';

            $.each(packet.prices, function (currency, data) {
                var cost_to_fill = use_full_cost ? data.amount : window.ceilNumber(data.amount/_self.passengerCount);
                prices += '<span data-currency="' +  currency + '" data-cost="' + window.formatNumber(data.amount, 2) + '" class="policies_price " ' + (data['default'] ? '' : 'hidden') + '>' + window.ceilNumber(cost_to_fill, 0) + ' ' + _self.currencies[currency] + '</span>';
            });

            cost_info = use_full_cost ? 'Цена за всех пассажиров' : 'Цена за 1 пассажира';

            var el = '<div class="insurance-block__item-package packet_block">'+
                '<div class="row grid-small">'+
                '<div class="package">'+
                '<input type="checkbox" class="form-checkbox" id="checkbox-v-'+ packet.id +'" data-packet="'+packet.id+'" data-keys="'+packet.code+'" data-provider="'+packet.provider_name+'">'+
                '<label class="form-checkbox__label" for="checkbox-v-'+ packet.id +'">'+
                '<strong>' + packet.name + '</strong>'+
                '</label>'+
                '<a href="' + packet.faq_link + '" class="js-magnific-link">Полные условия страховки</a>'+
                '</div>'+
                '<div class="price">'+
                '<strong>'+ prices +'</strong>'+
                '<span>'+cost_info+'</span>'+
                '</div>'+
                '</div>'+
                '</div>';
            _self.policiesList.filter('[data-provider="'+packet.provider_name+'"]').append(el).find('input').button();
        });
        _self.checkContent();
        window.enable_magnific();
    }

    InsuranceWithAvia.prototype.hideIfError = function(){
        this.insuranceWithAvia.val(0);
        this.mainWrapp.hide();
        this.reloadPrice();
    }

    $(function(){
        insWithAviaObj = new InsuranceWithAvia;
        if(canUseServiceInterface()){
            $.hub.getManager('service').add(insWithAviaObj);
        }else{
            PriceCalculationObj.addService(insWithAviaObj);
            insWithAviaObj.init();
            //console.warn('This is DEPRECATED! Use ServiceInterface instead');
        }
        disable_input_plugin(insWithAviaObj.mainWrapp);
        $('.view_ins_block').on('click', function(e){
            e.preventDefault();
            $('.insurance-table_cabinet').toggleClass('hidden');
        })
    });

    $('.js_hide_btn').on('click', function(){
        $(this).hide();
    });
</script>
<!-- AEROEXPRESS -->
<div class="js_aeroexpress additional-service__block hidden" id="aeroexpress_additional_service" data-auto-controller="AirAeroexpressController" data-service="aeroexpress">
    <div class="additional-services__aeroexpress">
        <div class="loader js-loader" style="display: none;">
            <img src="./payment_page_2_files/preloader_loader2(1).gif">
        </div>
        <div class="additional-aeroexpress__heading ">
            <img class="extra-img" src="./payment_page_2_files/extra-5.png">
            <strong>В аэропорт — вовремя!</strong>
            <strong>Аэроэкспресс — экономный способ успеть на самолет!</strong>
            <span class="free-wifi">
          <svg width="27" height="24">
            <use xlink:href="#wifi-icon" class="wifi-icon"></use>
          </svg>
          Бесплатный Wi-Fi        </span>
        </div>


        <div class="aeroexpress-price__item aeroexpress-price__item--wide js_aeroexpress_form js_aeroexpress_from">
            <input type="checkbox" name="aeroexpress[from][vnukovo|12-12-2017]" id="aeroexpress-item2" class="ui-helper-hidden-accessible">
            <label for="aeroexpress-item2" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false"><span class="ui-button-text">
              <svg width="18" height="18">
                <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox" class="icon-checkbox"></use>
                <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox1" class="icon-checkbox1"></use>
                <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-checkbox2" class="icon-checkbox2"></use>
              </svg>
              <strong>Внуково Аэропорт – Киевский вокзал</strong>
            </span></label>
            <div class="js_aeroexpress_price js_from" style="display:none;"><strong><span class="prices"><span data-cost="29.28" data-currency="PLN" data-default="false" class="ae_price hidden">29.28 PLN</span><span data-cost="6.89" data-currency="EUR" data-default="false" class="ae_price hidden">6.89 EUR</span><span data-cost="216.92" data-currency="UAH" data-default="false" class="ae_price hidden">216.92 UAH</span><span data-cost="8.03" data-currency="USD" data-default="false" class="ae_price hidden">8.03 USD</span><span data-cost="470.00" data-currency="RUR" data-default="true" class="ae_price ">470.00 RUR</span><span data-cost="13.66" data-currency="AZN" data-default="false" class="ae_price hidden">13.66 AZN</span><span data-cost="6.17" data-currency="GBP" data-default="false" class="ae_price hidden">6.17 GBP</span><span data-cost="2 687.86" data-currency="KZT" data-default="false" class="ae_price hidden">2 687.86 KZT</span><span data-cost="30.81" data-currency="TRY" data-default="false" class="ae_price hidden">30.81 TRY</span><span data-cost="15.92" data-currency="BYN" data-default="false" class="ae_price hidden">15.92 BYN</span></span></strong></div>
            <span class="aeroexpress-item__date right">Дата: <strong>12 декабря 2017</strong></span>
        </div>

        <div class="aeroexpress-passenger-info js_aeroexpress_passengers js_hide_passengers" style="display: none;">
            <p>Укажите тип и номер документа для каждого из пассажиров:</p>

            <div class="aeroexpress-passenger-info__item">
                <div class="row">
                    <div class="col-3">
                        <p class="one-pass-num"><strong>Пассажир 1</strong>
                            Petrov Ivan                </p>
                    </div>
                    <div class="col-4">
                        <span class="data-block__label">Документ</span>
                        <select class="chosen-select-default chosen-select chosen-container-single js_doctype_aeroexpress" name="aero_pass[0][doc_type]" required="required" style="display: none;">
                            <option value="0">Российский паспорт</option>
                            <option value="1" selected="">Другое удостоверение личности</option>
                        </select><div class="chosen-container chosen-container-single" style="width: 0px;" title=""><a class="chosen-single" tabindex="-1"><span>Другое удостоверение личности</span><div><b></b></div></a><div class="chosen-drop"><div class="chosen-search"><input type="text" autocomplete="off"></div><ul class="chosen-results"></ul></div></div>
                    </div>
                    <div class="col-3">
                        <span class="data-block__label">Серия и № документа<a href="javascript:void(0);" class="help-text js-tooltip-text tooltipstered"></a></span>
                        <input type="text" id="aer_doc1" class="data-block__textinput indexex js-off-correct only_alphanum_latin" name="aero_pass[0][docnum]" required="required" value="RS42342343">
                    </div>
                </div>
            </div>
        </div>

        <div class="additional-aeroexpress__footer aeroexpress_price all">
            <a href="https://avia.tickets.ru/content/aeroexpress.html" class="aeroexpress_about js-magnific-link">
                <svg width="14" height="14">
                    <use xlink:href="#info-icon" class="info-icon"></use>
                </svg>


                Подробнее про Аэроэкспресс</a>
            <a href="https://avia.tickets.ru/search/get_aeroexpress_timetable" onclick="return false;" class="tariff-link tariff-link__icon aeroexpress_timetable js-magnific-link" data-magnific-popup-options="{&quot;ajax&quot;:{&quot;settings&quot;:{&quot;data&quot;:{&quot;from&quot;:&quot;&quot;,&quot;to&quot;:&quot;vnukovokievsky&quot;},&quot;type&quot;:&quot;POST&quot;}},&quot;closeOnBgClick&quot;:true,&quot;enableEscapeKey&quot;:false,&quot;type&quot;:&quot;ajax&quot;}">Расписание</a>
            <!-- show this block if checked any checkbox -->
            <div class="price" style="display: none">
                <i>Итого для всех пассажиров:</i>
                <!-- show final price in this span -->
                <span>0 RUR</span>
            </div>
        </div>

    </div>
</div>
<script type="text/javascript">
    var canUseServiceInterface = function(){ return $.hub && $.hub.getManager('service') && typeof ServiceInterface === 'function' };

    var AeroexpressService = function() {
        this.id = "aeroexpress_service";
        this.mainWrapp = $('#aeroexpress_additional_service');
        this.checkboxes = $('input[type=checkbox]', this.mainWrapp);
        this.cost = 0;
        this.currencies = {"AED":"AED","AFN":"AFN","ALL":"ALL","AMD":"AMD","ANG":"ANG","AOA":"AOA","ARS":"ARS","AUD":"AUD","AWG":"AWG","AZM":"AZM","AZN":"AZN","BAM":"BAM","BBD":"BBD","BDT":"BDT","BGN":"BGN","BHD":"BHD","BIF":"BIF","BMD":"BMD","BND":"BND","BOB":"BOB","BRL":"BRL","BSD":"BSD","BTN":"BTN","BWP":"BWP","BYN":"BYN","BYR":"BYR","BZD":"BZD","CAD":"CAD","CDF":"CDF","CHF":"CHF","CLP":"CLP","CNY":"CNY","COP":"COP","CRC":"CRC","CUC":"CUC","CUP":"CUP","CVE":"CVE","CZK":"CZK","DJF":"DJF","DKK":"DKK","DOP":"DOP","DZD":"DZD","EEK":"EEK","EGP":"EGP","ERN":"ERN","ETB":"ETB","EUR":"EUR","FJD":"FJD","FKP":"FKP","GBP":"GBP","GEL":"GEL","GGP":"GGP","GHS":"GHS","GIP":"GIP","GMD":"GMD","GNF":"GNF","GTQ":"GTQ","GYD":"GYD","HKD":"HKD","HNL":"HNL","HRK":"HRK","HTG":"HTG","HUF":"HUF","IDR":"IDR","ILS":"ILS","IMP":"IMP","INR":"INR","IQD":"IQD","IRR":"IRR","ISK":"ISK","JEP":"JEP","JMD":"JMD","JOD":"JOD","JPY":"JPY","KES":"KES","KGS":"KGS","KHR":"KHR","KMF":"KMF","KPW":"KPW","KRW":"KRW","KWD":"KWD","KYD":"KYD","KZT":"KZT","LAK":"LAK","LBP":"LBP","LKR":"LKR","LRD":"LRD","LSL":"LSL","LTL":"LTL","LVL":"LVL","LYD":"LYD","MAD":"MAD","MDL":"MDL","MGA":"MGA","MKD":"MKD","MMK":"MMK","MNT":"MNT","MOP":"MOP","MRO":"MRO","MUR":"MUR","MVR":"MVR","MWK":"MWK","MXN":"MXN","MYR":"MYR","MZN":"MZN","NAD":"NAD","NGN":"NGN","NIO":"NIO","NOK":"NOK","NPR":"NPR","NZD":"NZD","OMR":"OMR","PAB":"PAB","PEN":"PEN","PGK":"PGK","PHP":"PHP","PKR":"PKR","PLN":"PLN","PYG":"PYG","QAR":"QAR","RON":"RON","RSD":"RSD","RUB":"RUR","RUR":"RUR","RWF":"RWF","SAR":"SAR","SBD":"SBD","SCR":"SCR","SDG":"SDG","SDR":"SDR","SEK":"SEK","SGD":"SGD","SHP":"SHP","SLL":"SLL","SOS":"SOS","SPL":"SPL","SRD":"SRD","SSP":"SSP","STD":"STD","SVC":"SVC","SYP":"SYP","SZL":"SZL","THB":"THB","TJS":"TJS","TMM":"TMM","TMT":"TMT","TND":"TND","TOP":"TOP","TRL":"TRL","TRY":"TRY","TTD":"TTD","TVD":"TVD","TWD":"TWD","TZS":"TZS","UAH":"UAH","UGX":"UGX","USD":"USD","UYU":"UYU","UZS":"UZS","VEF":"VEF","VND":"VND","VUV":"VUV","WST":"WST","XAF":"XAF","XAG":"XAG","XAU":"XAU","XCD":"XCD","XDR":"XDR","XOF":"XOF","XPD":"XPD","XPF":"XPF","XPT":"XPT","YER":"YER","ZAR":"ZAR","ZMK":"ZMK","ZWD":"ZWD","ZWL":"ZWL"};

        if(canUseServiceInterface()) ServiceInterface.call(this);
    }

    if(canUseServiceInterface()){
        AeroexpressService.prototype = Object.create(ServiceInterface.prototype);
        AeroexpressService.prototype.constructor = AeroexpressService;
    }

    AeroexpressService.prototype.init = function() {
        var _self = this;
        _self.reloadPrice();
        this.checkboxes.on('change', function(ev) {
            setTimeout(function() {
                _self.allowNotify(true);
                _self.reloadPrice();
            });
        }),

            $(".js_doctype_aeroexpress").on("change", function(ev){
                var val = Number($(ev.target).val());
                var inp = $(ev.target).parent().next().find("input");

                inp.val('');
                inp.removeClass('only_numbers');
                inp.removeClass('only_alphanum_latin');
                inp.removeAttr('placeholder');
                inp.removeAttr('maxlength');
                inp.removeAttr('minlength');

                if (val == 0) {
                    inp.addClass('only_numbers');
                    inp.attr('placeholder', '1234567890');
                    inp.attr('maxlength', '10');
                    inp.attr('minlength', '10');
                } else {
                    inp.addClass('only_alphanum_latin');
                }
            })
    }

    AeroexpressService.prototype.reloadPrice = function() {
        this.reloadCost();
        PriceCalculationObj.reloadPrice();
        this.notify();
    }

    AeroexpressService.prototype.reloadCost = function() {
        var _self = this;
        var services_cost = 0;
        var currency = '';
        var checked_count = 0;
        var selected_aeroexpress_services = [];

        this.checkboxes.each(function(i, ch) {
            var el = $(ch);
            el.parents('.js_aeroexpress_form').find('.ae_price').addClass('hidden');

            var currency = default_currency;
            if($('.payment_block').controller() != undefined){
                currency = $('.payment_block').controller().cost.getActivePaymentSystem().getCurrency();
            }

            var sel_ps = el.parents('.js_aeroexpress_form').find('span.ae_price[data-currency='+currency+']');
            if(sel_ps.length > 0){
                sel_ps.removeClass('hidden');
            }

            if( el.is(":checked") ){
                checked_count++;
                currency = sel_ps.text().split(' ').slice(-1);
                services_cost += parseFloat( sel_ps.text().replace(' ', '') );
            }
            if(checked_count > 0){
                $('.aeroexpress_price .price, .js_aeroexpress_passengers:not(.js_hide_passengers)').show();
                $('.aeroexpress_price .price span').html(services_cost + ' ' + currency);
            }else{
                $('.aeroexpress_price .price, .js_aeroexpress_passengers:not(.js_hide_passengers)').hide();
            }
        });

        $('.payment_block').controller().additionalPricesSet('aeroexpress',$('#up_ad_text_js').data('aeroexpress'),services_cost);
        if (services_cost > 0) {
            var price = services_cost;

            var decimalPrecisions = $('.way_th').data('decimal-precisions') || false;
            var prec = 2;
            if(typeof decimalPrecisions == 'object'){
                if(decimalPrecisions[currency]){
                    prec = 0;
                }
            }else if(decimalPrecisions){
                prec = 0;
            }

            price = window.ceilNumber(price, prec);
            $('.additional_services.aeroexpress .aeroexpress_price.all span.prices').text(price + ' ' + currency);
            $('.additional_services.aeroexpress .aeroexpress_price.all .additional').show();
            if (checked_count == 1) {
                $('#one_way_aer_count').show();
                $('#round_trip_aer_count').hide();
            } else {
                $('#one_way_aer_count').hide();
                $('#round_trip_aer_count').show();
            }
            _self.changeCurrency($('.payment_block').controller().cost.getActivePaymentSystem().getCurrency());
        }
        else {
            $('.additional_services.aeroexpress .aeroexpress_price.all .additional').hide();
        }

        this.cost = services_cost;
        PriceCalculationObj.bookingPriceButton().find('span.additional_service_aeroexpress').toggle(services_cost > 0);

        if (this.cost > 0) {
            selected_aeroexpress_services.push({'label': 'Аэроэкспресс', 'price': this.cost})
        }

        if (typeof avia_sub_total != 'undefined') {
            avia_sub_total.add_service('aeroexpress_services', selected_aeroexpress_services);
            avia_sub_total.reload();
        }

        if(canUseServiceInterface()){
            this.setCost(services_cost);
        }
    }

    AeroexpressService.prototype.toggleService = function(bool) {
        var _self = this;
        var value = Boolean(bool);
        if(value) {
            $(".js_aeroexpress input[type=checkbox]").iCheck('enable');
            $('.js_aeroexpress').show();
        } else {
            $(".js_aeroexpress input[type=checkbox]").iCheck('disable');
            $('.js_aeroexpress').hide();
        }
    }
    AeroexpressService.prototype.toggleService = function(bool) {
        var _self = this;
        var value = Boolean(bool);
        if(value) {
            $(".js_aeroexpress input[type=checkbox]").iCheck('enable');
            $('.js_aeroexpress').show();
        } else {
            $(".js_aeroexpress input[type=checkbox]").iCheck('disable');
            $('.js_aeroexpress').hide();
        }
    }
    AeroexpressService.prototype.subscribers = [];

    if(!canUseServiceInterface()){
        AeroexpressService.prototype.notify = function(){
            var self = this;
            this.subscribers.forEach(function(subscriber){
                subscriber.updateService(self);
            });
        };
    }

    AeroexpressService.prototype.addSubscriber = function(subscriber){
        if(typeof subscriber.updateService === 'function'){
            this.subscribers.push(subscriber);
        }else{
            console.warn("subscriber doesn't provide updateService method");
        }
    };

    AeroexpressService.prototype.changeCurrency = function(currency) {
        var _self = this;
        _self.showElWithCurrency(currency, $('.js_aeroexpress_price .prices .ae_price'));
    }

    AeroexpressService.prototype.showElWithCurrency = function(currency, els) {
        var services_cost = 0;

        $.each(els, function(index, el) {
            if($(el).data('currency').toUpperCase() == currency.toUpperCase()) {
                $(el).removeClass('hidden');
            } else {
                $(el).addClass('hidden');
            }
        })

        this.checkboxes.each(function(i, ch) {
            var el = $(ch);
            if( el.is(":checked") ){
                var sel_ps = el.parents('.js_aeroexpress_form').find('span.ae_price[data-currency='+currency.toUpperCase()+']');
                services_cost += parseFloat( sel_ps.text().replace(' ', '') );
            }
        })

        $('.aeroexpress_price .price span').html(services_cost + ' ' + currency);
        if(canUseServiceInterface()){
            this.setCost(services_cost);
        }
    }

    $(function(){
        $('.js_aeroexpress_passengers').hide();
        var params = $.parseParams(window.location.search.replace("?",""));
        var json_data = {
            passengers: 1,
            avia_system_id: "21",
            session_id: params['session_id'],
            recommendation_id: params['recommendation_id']
        };
        var trip_dates = {};
        json_data['from'] = 'vnukovo';
        trip_dates['from_date'] = 1513082400;

        var currencies = {"AED":"AED","AFN":"AFN","ALL":"ALL","AMD":"AMD","ANG":"ANG","AOA":"AOA","ARS":"ARS","AUD":"AUD","AWG":"AWG","AZM":"AZM","AZN":"AZN","BAM":"BAM","BBD":"BBD","BDT":"BDT","BGN":"BGN","BHD":"BHD","BIF":"BIF","BMD":"BMD","BND":"BND","BOB":"BOB","BRL":"BRL","BSD":"BSD","BTN":"BTN","BWP":"BWP","BYN":"BYN","BYR":"BYR","BZD":"BZD","CAD":"CAD","CDF":"CDF","CHF":"CHF","CLP":"CLP","CNY":"CNY","COP":"COP","CRC":"CRC","CUC":"CUC","CUP":"CUP","CVE":"CVE","CZK":"CZK","DJF":"DJF","DKK":"DKK","DOP":"DOP","DZD":"DZD","EEK":"EEK","EGP":"EGP","ERN":"ERN","ETB":"ETB","EUR":"EUR","FJD":"FJD","FKP":"FKP","GBP":"GBP","GEL":"GEL","GGP":"GGP","GHS":"GHS","GIP":"GIP","GMD":"GMD","GNF":"GNF","GTQ":"GTQ","GYD":"GYD","HKD":"HKD","HNL":"HNL","HRK":"HRK","HTG":"HTG","HUF":"HUF","IDR":"IDR","ILS":"ILS","IMP":"IMP","INR":"INR","IQD":"IQD","IRR":"IRR","ISK":"ISK","JEP":"JEP","JMD":"JMD","JOD":"JOD","JPY":"JPY","KES":"KES","KGS":"KGS","KHR":"KHR","KMF":"KMF","KPW":"KPW","KRW":"KRW","KWD":"KWD","KYD":"KYD","KZT":"KZT","LAK":"LAK","LBP":"LBP","LKR":"LKR","LRD":"LRD","LSL":"LSL","LTL":"LTL","LVL":"LVL","LYD":"LYD","MAD":"MAD","MDL":"MDL","MGA":"MGA","MKD":"MKD","MMK":"MMK","MNT":"MNT","MOP":"MOP","MRO":"MRO","MUR":"MUR","MVR":"MVR","MWK":"MWK","MXN":"MXN","MYR":"MYR","MZN":"MZN","NAD":"NAD","NGN":"NGN","NIO":"NIO","NOK":"NOK","NPR":"NPR","NZD":"NZD","OMR":"OMR","PAB":"PAB","PEN":"PEN","PGK":"PGK","PHP":"PHP","PKR":"PKR","PLN":"PLN","PYG":"PYG","QAR":"QAR","RON":"RON","RSD":"RSD","RUB":"RUR","RUR":"RUR","RWF":"RWF","SAR":"SAR","SBD":"SBD","SCR":"SCR","SDG":"SDG","SDR":"SDR","SEK":"SEK","SGD":"SGD","SHP":"SHP","SLL":"SLL","SOS":"SOS","SPL":"SPL","SRD":"SRD","SSP":"SSP","STD":"STD","SVC":"SVC","SYP":"SYP","SZL":"SZL","THB":"THB","TJS":"TJS","TMM":"TMM","TMT":"TMT","TND":"TND","TOP":"TOP","TRL":"TRL","TRY":"TRY","TTD":"TTD","TVD":"TVD","TWD":"TWD","TZS":"TZS","UAH":"UAH","UGX":"UGX","USD":"USD","UYU":"UYU","UZS":"UZS","VEF":"VEF","VND":"VND","VUV":"VUV","WST":"WST","XAF":"XAF","XAG":"XAG","XAU":"XAU","XCD":"XCD","XDR":"XDR","XOF":"XOF","XPD":"XPD","XPF":"XPF","XPT":"XPT","YER":"YER","ZAR":"ZAR","ZMK":"ZMK","ZWD":"ZWD","ZWL":"ZWL"};
        var service = window.has_subdomais ? '' :'/' + window.cur_domain_name;

        aeroexpressServicesObj = new AeroexpressService;
        if(canUseServiceInterface()){
            $.hub.getManager('service').add(aeroexpressServicesObj);
        }else{
            aeroexpressServicesObj.init();
            PriceCalculationObj.addService(aeroexpressServicesObj);
            console.warn('This is DEPRECATED! Use ServiceInterface instead');
        }

        $.getJSON(service + '/search/get_aeroexpress_price', json_data, function(data){
            if(data.length == 0){
                $('#aeroexpress_additional_service').remove();
            } else {
                var seconds = Math.round(new Date().getTime() / 1000);

                if (typeof data['from_max_days'] != 'undefined') {
                    var max_time = seconds + data['from_max_days'] * 86400;
                    if (trip_dates['from_date'] > max_time) {
                        $('.js_aeroexpress_form.js_aeroexpress_from').remove();
                    }
                }

                if (typeof data['to_max_days'] != 'undefined') {
                    var max_time = seconds + data['to_max_days'] * 86400;
                    if (trip_dates['to_date'] > max_time) {
                        $('.js_aeroexpress_form.js_aeroexpress_to').remove();
                    }
                }

                if ($('.js_aeroexpress_form').length == 0) {
                    $('#aeroexpress_additional_service').remove();
                } else {
                    prices = data['prices'];
                    for(var k in prices){
                        html = '';
                        for(var currency in prices[k]){
                            span_class = (prices[k][currency].default ? '' : 'hidden');
                            html += '<span data-cost="'+window.formatNumber(prices[k][currency].amount, 2)+'" data-currency="' + currency + '" data-default="' + prices[k][currency].default + '" class="ae_price ' + span_class + '">'+window.formatNumber(prices[k][currency].amount, 2) + ' ' + aeroexpressServicesObj.currencies[currency] + '</span>';
                        }
                        $('.js_aeroexpress .js_aeroexpress_price.js_' + k + ' span.prices').append(html);
                    }
                    // add loader
                    $('.js_aeroexpress .js-loader').hide();
                }
            }
        });
    });
</script>